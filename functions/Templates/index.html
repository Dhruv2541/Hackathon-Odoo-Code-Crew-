<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { 
    getAuth, 
    signInWithPopup, 
    GoogleAuthProvider, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDpnDUR68bl17HRgfrLKFPeje1L3Qi5p1I",
    authDomain: "test-5bff2.firebaseapp.com",
    projectId: "test-5bff2",
    storageBucket: "test-5bff2.firebasestorage.app",
    messagingSenderId: "820559758291",
    appId: "1:820559758291:web:6608f29bf15d44a1612526"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Make auth methods available to the other script
  window.firebase = { auth: { getAuth, signOut } };

  const googleBtn = document.getElementById('google-signup-btn');

  // Handle Google Login
  googleBtn.addEventListener('click', async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      // Sync with Flask backend and get full user object
      const response = await fetch('/api/auth/google', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          uid: user.uid,
          email: user.email,
          name: user.displayName
        })
      });
      const backendUser = await response.json();
      
      if (typeof window.handleLogin === 'function') {
          window.handleLogin(backendUser); // Pass full user object from our DB
      }
    } catch (error) {
      console.error("Auth Error:", error.message);
      alert("Login failed: " + error.message);
    }
  });

  // Monitor Auth State
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        // User is signed in, re-sync with backend to get our user object
        const response = await fetch('/api/auth/google', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                uid: user.uid,
                email: user.email,
                name: user.displayName
            })
        });
        const backendUser = await response.json();
        if (typeof window.handleLogin === 'function') {
            window.handleLogin(backendUser);
        }
    } else {
      // User is signed out.
      if (typeof window.handleLogout === 'function') {
        window.handleLogout();
      }
    }
  });
</script>